<script id="sitemap-data" type="application/json">
[
  {%- assign valid_pages = "" | split: "" -%}
  
  {%- for p in site.pages -%}
    {%- if p.lang_ref -%}
      {%- capture json_item -%}
      {
        "url": "{{ p.url | relative_url }}",
        "id": "{{ p.lang_ref }}",
        "lang": "{{ p.lang }}"
      }
      {%- endcapture -%}
      {%- assign valid_pages = valid_pages | push: json_item -%}
    {%- endif -%}
  {%- endfor -%}
  
  {{ valid_pages | join: "," }}
]
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {

  // --- Veriyi Oku ve Çöz ---
  var rawData = document.getElementById('sitemap-data').textContent;
  var siteMap = [];
  try {
    siteMap = JSON.parse(rawData);
    console.log("DEBUG: SiteMap başarıyla yüklendi. Toplam sayfa:", siteMap.length);
  } catch (e) {
    console.error("JSON Hatası Devam Ediyor:", e);
    console.log("Hatalı Veri:", rawData); // Hatayı görmek için veriyi bas
  }

  // --- Normalizasyon (Tıraşlama) ---
  function normalize(path) {
    if (!path) return "";
    try {
      if (path.startsWith("http")) path = new URL(path).pathname;
    } catch(e) {}
    
    path = path.replace(window.location.origin, "");
    path = path.replace("/index.html", "");
    path = path.replace("index.html", "");

    if (path.endsWith("/") && path.length > 1) path = path.slice(0, -1);
    if (!path.startsWith("/")) path = "/" + path;

    return path;
  }

  // --- EŞLEŞTİRME ---
  var currentPath = normalize(window.location.pathname);
  console.log("DEBUG: Şu anki Sayfa (Normalize):", currentPath);

  var myPage = null;
  // SiteMap içindeki URL'leri de normalize ederek ara
  for (var i = 0; i < siteMap.length; i++) {
    if (normalize(siteMap[i].url) === currentPath) {
      myPage = siteMap[i];
      console.log("DEBUG: Eşleşme Bulundu! ID:", myPage.id, "| Dil:", myPage.lang);
      break;
    }
  }

  if (myPage) {
    var partnerPage = null;
    for (var j = 0; j < siteMap.length; j++) {
      if (siteMap[j].id === myPage.id && siteMap[j].lang !== myPage.lang) {
        partnerPage = siteMap[j];
        break;
      }
    }

    if (partnerPage) {
      console.log("DEBUG: Hedef Link ->", partnerPage.url);
      var targetUrl = partnerPage.url;
      
      // Butonları Bul ve Değiştir
      var selectors = [
        'a[href="/en/"]', 'a[href="en/"]', 'a[href="/en"]',
        'a[href="/tr/"]', 'a[href="tr/"]', 'a[href="/tr"]'
      ];
      
      // Hangi dildeysek tersini arayacağız ama burada genel bir tarama yapıp
      // doğru butonu bulmak daha garanti.
      if (myPage.lang === 'tr') {
        // İngilizce butonlarını dene
        var enBtn = document.querySelector('a[href="/en/"]') || 
                    document.querySelector('a[href="en/"]') || 
                    document.querySelector('a[href="/en"]');
        if (enBtn) enBtn.setAttribute('href', targetUrl);
      } 
      else if (myPage.lang === 'en') {
        // Türkçe butonlarını dene
        var trBtn = document.querySelector('a[href="/tr/"]') || 
                    document.querySelector('a[href="tr/"]') || 
                    document.querySelector('a[href="/tr"]');
        if (trBtn) trBtn.setAttribute('href', targetUrl);
      }

    } else {
      console.warn("DEBUG: Sayfa bulundu ama 'kardeş sayfası' (diğer dildeki hali) yok.");
    }
  } else {
    console.warn("DEBUG: Eşleşme YOK. Normalize edilen URL listede bulunamadı.");
  }

  // --- Dış Linkler ---
  var links = document.links;
  for (var k = 0; k < links.length; k++) {
    if (links[k].hostname != window.location.hostname) {
      links[k].target = '_blank';
      links[k].rel = 'noopener noreferrer';
    } else if (links[k].href.endsWith(".pdf")) {
      links[k].target = '_blank';
    }
  }

});
</script>