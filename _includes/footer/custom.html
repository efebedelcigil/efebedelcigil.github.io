<script id="sitemap-data" type="application/json">
[
  {%- assign valid_pages = "" | split: "" -%}
  {%- for p in site.pages -%}
    {%- if p.lang_ref -%}
      {%- capture json_item -%}
      {
        "url": "{{ p.url | relative_url }}",
        "id": "{{ p.lang_ref }}",
        "lang": "{{ p.lang }}"
      }
      {%- endcapture -%}
      {%- assign valid_pages = valid_pages | push: json_item -%}
    {%- endif -%}
  {%- endfor -%}
  {{ valid_pages | join: "," }}
]
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {

  // --- Veriyi Oku ---
  var rawData = document.getElementById('sitemap-data').textContent;
  var siteMap = [];
  try {
    siteMap = JSON.parse(rawData);
  } catch (e) {
    // Sessizce geç (Production'da konsolu kirletmeye gerek yok)
  }

  // --- Normalizasyon (URL Temizleme) ---
  function normalize(path) {
    if (!path) return "";
    try {
      if (path.startsWith("http")) path = new URL(path).pathname;
    } catch(e) {}
    
    path = path.replace(window.location.origin, "");
    path = path.replace("/index.html", "");
    path = path.replace("index.html", "");

    if (path.endsWith("/") && path.length > 1) path = path.slice(0, -1);
    if (!path.startsWith("/")) path = "/" + path;

    return path;
  }

  // --- Dil Değiştirme Mantığı ---
  var currentPath = normalize(window.location.pathname);
  var myPage = null;

  // Şu anki sayfayı bul
  for (var i = 0; i < siteMap.length; i++) {
    if (normalize(siteMap[i].url) === currentPath) {
      myPage = siteMap[i];
      break;
    }
  }

  // Kardeş sayfayı bul ve butonu güncelle
  if (myPage) {
    var partnerPage = null;
    for (var j = 0; j < siteMap.length; j++) {
      if (siteMap[j].id === myPage.id && siteMap[j].lang !== myPage.lang) {
        partnerPage = siteMap[j];
        break;
      }
    }

    if (partnerPage) {
      var targetUrl = partnerPage.url;
      
      if (myPage.lang === 'tr') {
        var enBtn = document.querySelector('a[href="/en/"]') || 
                    document.querySelector('a[href="en/"]') || 
                    document.querySelector('a[href="/en"]');
        if (enBtn) enBtn.setAttribute('href', targetUrl);
      } 
      else if (myPage.lang === 'en') {
        var trBtn = document.querySelector('a[href="/tr/"]') || 
                    document.querySelector('a[href="tr/"]') || 
                    document.querySelector('a[href="/tr"]');
        if (trBtn) trBtn.setAttribute('href', targetUrl);
      }
    }
  }

  // --- Dış Linkler ve PDF Ayarları ---
  var links = document.links;
  for (var k = 0; k < links.length; k++) {
    if (links[k].hostname != window.location.hostname) {
      links[k].target = '_blank';
      links[k].rel = 'noopener noreferrer';
    } else if (links[k].href.endsWith(".pdf")) {
      links[k].target = '_blank';
    }
  }

});
</script>