<script>
document.addEventListener("DOMContentLoaded", function() {
  
  // A) Elementleri Oluştur
  var body = document.body;
  
  var progressBar = document.createElement('div');
  progressBar.id = 'reading-progress-bar';
  body.appendChild(progressBar);

  var scrollBtn = document.createElement('button');
  scrollBtn.id = 'scroll-to-top';
  scrollBtn.innerHTML = '⬆';
  scrollBtn.title = "Yukarı Çık";
  body.appendChild(scrollBtn);

  var lightbox = document.createElement('div');
  lightbox.className = 'lightbox-overlay';
  lightbox.innerHTML = '<img src="" alt="Zoom">';
  body.appendChild(lightbox);

  // B) Dark Mode & Flicker Fix
  var toggleBtn = document.getElementById('theme-toggle');
  
  // Head scripti HTML'e eklemişti, Body'ye de ekleyelim
  if (document.documentElement.classList.contains('dark-mode')) {
    body.classList.add('dark-mode');
  }

  if (toggleBtn) {
    toggleBtn.addEventListener('click', function() {
      requestAnimationFrame(function() {
        document.documentElement.classList.toggle('dark-mode');
        document.body.classList.toggle('dark-mode');
        var isDark = document.documentElement.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
      });
    });
  }
  
  setTimeout(function() {
    document.documentElement.classList.remove('preload');
    document.body.classList.remove('preload');
  }, 200);

  // C) SCROLL MANTIĞI
  window.addEventListener('scroll', function() {
    var winScroll = document.body.scrollTop || document.documentElement.scrollTop;
    var height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    var scrolled = (winScroll / height) * 100;
    progressBar.style.width = scrolled + "%";

    if (winScroll > 300) {
      scrollBtn.classList.add('show');
    } else {
      scrollBtn.classList.remove('show');
    }
  });

  scrollBtn.addEventListener('click', function() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // D) LIGHTBOX
  var images = document.querySelectorAll('.page__content img');
  var lightboxImg = lightbox.querySelector('img');

  images.forEach(function(img) {
    img.style.cursor = 'zoom-in';
    img.addEventListener('click', function() {
      lightboxImg.src = this.src;
      lightbox.classList.add('active');
      document.body.style.overflow = 'hidden';
    });
  });

  lightbox.addEventListener('click', function() {
    lightbox.classList.remove('active');
    document.body.style.overflow = 'auto';
  });

  // E) KOD BLOKLARI (VS Code Style)
  var codeBlocks = document.querySelectorAll('div.highlighter-rouge');
  codeBlocks.forEach(function(block) {
    if (!block.querySelector('.code-header')) {
        var header = document.createElement('div');
        header.className = 'code-header';
        var controls = document.createElement('div');
        controls.className = 'code-controls';
        controls.innerHTML = '<div class="code-dot dot-red"></div><div class="code-dot dot-yellow"></div><div class="code-dot dot-green"></div>';
        var copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.innerText = 'Copy';
        header.appendChild(controls);
        header.appendChild(copyBtn);
        block.insertBefore(header, block.firstChild);

        copyBtn.addEventListener('click', function() {
          var code = block.querySelector('pre').innerText;
          navigator.clipboard.writeText(code).then(function() {
            copyBtn.innerText = 'Copied!';
            setTimeout(function() { copyBtn.innerText = 'Copy'; }, 2000);
          });
        });
    }
  });

});
</script>

<script id="sitemap-data" type="application/json">
[
  {%- assign valid_pages = "" | split: "" -%}
  {%- for p in site.pages -%}
    {%- if p.lang_ref -%}
      {%- capture json_item -%}
      { "url": "{{ p.url | relative_url }}", "id": "{{ p.lang_ref }}", "lang": "{{ p.lang }}" }
      {%- endcapture -%}
      {%- assign valid_pages = valid_pages | push: json_item -%}
    {%- endif -%}
  {%- endfor -%}
  {{ valid_pages | join: "," }}
]
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  
  // --- Dil Değiştirme ---
  var rawDataElement = document.getElementById('sitemap-data');
  var siteMap = [];
  if (rawDataElement) { try { siteMap = JSON.parse(rawDataElement.textContent); } catch (e) {} }

  function normalize(path) {
    if (!path) return "";
    try { if (path.startsWith("http")) path = new URL(path).pathname; } catch(e) {}
    path = path.replace(window.location.origin, "").replace(/\/index\.html$/, "").replace(/index\.html$/, "");
    if (path.endsWith("/") && path.length > 1) path = path.slice(0, -1);
    if (!path.startsWith("/")) path = "/" + path;
    return path;
  }

  var currentPath = normalize(window.location.pathname);
  var myPage = siteMap.find(function(p) { return normalize(p.url) === currentPath; });

  if (myPage) {
    var partnerPage = siteMap.find(function(p) { return p.id === myPage.id && p.lang !== myPage.lang; });
    if (partnerPage) {
      var selector = myPage.lang === 'tr' ? 'a[href*="/en"]' : 'a[href*="/tr"]';
      var langBtn = document.querySelector(selector);
      if (langBtn) {
         var href = langBtn.getAttribute('href');
         if(href && (href.includes('/en') || href.includes('/tr') || href.includes('en/') || href.includes('tr/'))) {
             langBtn.setAttribute('href', partnerPage.url);
         }
      }
    }
  }

  // --- External Links ---
  var links = document.links;
  for (var k = 0; k < links.length; k++) {
    if (links[k].hostname != window.location.hostname) {
      links[k].target = '_blank'; links[k].rel = 'noopener noreferrer';
    } else if (links[k].href.endsWith(".pdf")) {
      links[k].target = '_blank';
    }
  }
  
  // --- GELİŞMİŞ HIGHLIGHTER (SORUNSUZ) ---
  var urlParams = new URLSearchParams(window.location.search);
  var query = urlParams.get('q') || urlParams.get('highlight');

  if (query && query.length > 1) { // En az 2 harf olsun
    var cleanQuery = query.replace(/[^\w\sğüşıöçĞÜŞİÖÇ]/gi, ''); // Türkçe karakter desteği
    console.log("Highlight Aktif! Aranan:", cleanQuery);

    // Sadece içerikte ara (Başlıkları ve menüyü bozma)
    var context = document.querySelector('.page__content') || document.body;
    
    // Regex: Kelimeyi bul, büyük küçük harf duyarsız (gi)
    // Parantez () içine aldık ki split yapınca kaybolmasın
    var regex = new RegExp("(" + cleanQuery + ")", "gi");

    function highlightRecursive(node) {
      // Eğer bu bir metin düğümü ise ve aranan kelimeyi içeriyorsa
      if (node.nodeType === 3) { 
        var val = node.nodeValue;
        if (regex.test(val)) {
          var fragment = document.createDocumentFragment();
          var parts = val.split(regex); // Metni parçala: ["Merhaba ", "v2x", " projesi"]

          parts.forEach(function(part) {
            // Eğer parça aranan kelimeye eşitse (büyük/küçük harf farketmeksizin)
            if (part.toLowerCase() === cleanQuery.toLowerCase()) {
              var mark = document.createElement("mark");
              mark.className = "highlighted-term";
              mark.textContent = part; // Orijinal harf yapısını koru (V2X ise V2X kalsın)
              fragment.appendChild(mark);
            } else {
              fragment.appendChild(document.createTextNode(part));
            }
          });

          node.parentNode.replaceChild(fragment, node);
          return true; // Değişiklik yapıldı
        }
      } 
      // Eğer bu bir element düğümü ise ve script/style değilse içine gir
      else if (node.nodeType === 1 && node.nodeName !== "SCRIPT" && node.nodeName !== "STYLE" && !node.classList.contains('highlighted-term')) {
        for (var i = 0; i < node.childNodes.length; i++) {
          highlightRecursive(node.childNodes[i]);
        }
      }
    }

    highlightRecursive(context);

    // İlk bulunan yere kaydır
    setTimeout(function(){
      var firstMark = document.querySelector('mark.highlighted-term');
      if (firstMark) {
        firstMark.scrollIntoView({behavior: "smooth", block: "center"});
      }
    }, 500);
  }
});
</script>