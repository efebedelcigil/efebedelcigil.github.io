<script id="sitemap-data" type="application/json">
[
  {%- assign valid_pages = "" | split: "" -%}
  {%- for p in site.pages -%}
    {%- if p.lang_ref -%}
      {%- capture json_item -%}
      {
        "url": "{{ p.url | relative_url }}",
        "id": "{{ p.lang_ref }}",
        "lang": "{{ p.lang }}"
      }
      {%- endcapture -%}
      {%- assign valid_pages = valid_pages | push: json_item -%}
    {%- endif -%}
  {%- endfor -%}
  {{ valid_pages | join: "," }}
]
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {

  // --- Veriyi Oku ---
  var rawData = document.getElementById('sitemap-data').textContent;
  var siteMap = [];
  try {
    siteMap = JSON.parse(rawData);
  } catch (e) {
    // Sessizce geç
  }

  // --- Normalizasyon ---
  function normalize(path) {
    if (!path) return "";
    try {
      if (path.startsWith("http")) path = new URL(path).pathname;
    } catch(e) {}
    
    path = path.replace(window.location.origin, "");
    path = path.replace("/index.html", "");
    path = path.replace("index.html", "");

    if (path.endsWith("/") && path.length > 1) path = path.slice(0, -1);
    if (!path.startsWith("/")) path = "/" + path;

    return path;
  }

  // --- Dil Değiştirme Mantığı ---
  var currentPath = normalize(window.location.pathname);
  var myPage = null;

  // Şu anki sayfayı bul
  for (var i = 0; i < siteMap.length; i++) {
    if (normalize(siteMap[i].url) === currentPath) {
      myPage = siteMap[i];
      break;
    }
  }

  // Kardeş sayfayı bul ve butonu güncelle
  if (myPage) {
    var partnerPage = null;
    for (var j = 0; j < siteMap.length; j++) {
      if (siteMap[j].id === myPage.id && siteMap[j].lang !== myPage.lang) {
        partnerPage = siteMap[j];
        break;
      }
    }

    if (partnerPage) {
      var targetUrl = partnerPage.url;
      
      if (myPage.lang === 'tr') {
        var enBtn = document.querySelector('a[href="/en/"]') || 
                    document.querySelector('a[href="en/"]') || 
                    document.querySelector('a[href="/en"]');
        if (enBtn) enBtn.setAttribute('href', targetUrl);
      } 
      else if (myPage.lang === 'en') {
        var trBtn = document.querySelector('a[href="/tr/"]') || 
                    document.querySelector('a[href="tr/"]') || 
                    document.querySelector('a[href="/tr"]');
        if (trBtn) trBtn.setAttribute('href', targetUrl);
      }
    }
  }

  // --- Dış Linkler ve PDF ---
  var links = document.links;
  for (var k = 0; k < links.length; k++) {
    if (links[k].hostname != window.location.hostname) {
      links[k].target = '_blank';
      links[k].rel = 'noopener noreferrer';
    } else if (links[k].href.endsWith(".pdf")) {
      links[k].target = '_blank';
    }
  }

});
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  
  var toggleBtn = document.getElementById('theme-toggle');
  var body = document.body;
  
  // A) Kayıtlı Temayı Uygula (Head kısmında da yaptık ama garanti olsun)
  var currentTheme = localStorage.getItem('theme');
  if (currentTheme === 'dark') {
    body.classList.add('dark-mode');
  }

  // B) PRELOAD KALDIRMA (Animasyonları serbest bırak)
  // Biraz bekletip (100ms) sınıfı siliyoruz ki sayfa oturmuş olsun.
  setTimeout(function() {
    document.body.classList.remove('preload');
    document.documentElement.classList.remove('preload');
  }, 100);

  // C) Tıklama Olayı
  if (toggleBtn) {
    toggleBtn.addEventListener('click', function() {
      body.classList.toggle('dark-mode');
      
      if (body.classList.contains('dark-mode')) {
        localStorage.setItem('theme', 'dark');
      } else {
        localStorage.setItem('theme', 'light');
      }
    });
  }
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  var urlParams = new URLSearchParams(window.location.search);
  var query = urlParams.get('q') || urlParams.get('highlight');

  if (query && query.length > 2) {
    var cleanQuery = query.replace(/[^\w\s]/gi, ''); // Güvenlik temizliği
    
    var context = document.querySelector('.page__content') || document.body;
    
    // Basit Highlight Fonksiyonu
    function highlightText(element, text) {
      if (element.hasChildNodes()) {
        element.childNodes.forEach(function(node) {
          highlightText(node, text);
        });
      } else if (element.nodeType === 3) { // Text node
        var val = element.nodeValue;
        var regex = new RegExp("(" + text + ")", "gi");
        if (val.match(regex)) {
          var span = document.createElement("span");
          // Sarı vurgu stili
          span.innerHTML = val.replace(regex, '<mark style="background:yellow; color:black; border-radius:3px; padding:0 2px;">$1</mark>');
          element.parentNode.replaceChild(span, element);
          
          if (!window.scrolledToHighlight) {
            span.scrollIntoView({behavior: "smooth", block: "center"});
            window.scrolledToHighlight = true;
          }
        }
      }
    }
    
    highlightText(context, cleanQuery);
  }
});
</script>