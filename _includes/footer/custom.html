<script>
// 1. SİTE HARİTASI (Veritabanı)
var siteMap = [
  {% for p in site.pages %}
    {% if p.lang_ref %}
      { 
        url: "{{ p.url | relative_url }}", 
        id: "{{ p.lang_ref }}", 
        lang: "{{ p.lang }}" 
      },
    {% endif %}
  {% endfor %}
];

document.addEventListener("DOMContentLoaded", function() {

  // --- NORMALİZASYON FONKSİYONU ---
  // Linkleri karşılaştırılabilir hale getirir (Tıraşlama)
  function normalize(path) {
    if (!path) return "";
    
    // 1. Domain'i (http://...) sil, sadece /tr/... kalsın
    var clean = path.replace(window.location.origin, "");
    
    // 2. Eğer varsa 'baseurl' kısmını sil (Gerekirse burayı açarız)
    // clean = clean.replace("/repo-adi", ""); 

    // 3. Varsa 'index.html' kısmını sil
    clean = clean.replace("index.html", "");

    // 4. En sondaki slash'ı sil (En önemli kısım!)
    if (clean.endsWith("/")) {
      clean = clean.slice(0, -1);
    }

    return clean;
  }

  // --- EŞLEŞTİRME MOTORU ---
  
  var currentRaw = window.location.pathname;
  var currentNorm = normalize(currentRaw);

  console.log("DEBUG: Şu anki Sayfa (Ham):", currentRaw);
  console.log("DEBUG: Şu anki Sayfa (Normalize):", currentNorm);

  // Haritadan beni bul
  var myPage = null;
  for (var i = 0; i < siteMap.length; i++) {
    var mapUrlNorm = normalize(siteMap[i].url);
    
    // Konsola listedeki her sayfayı yazmıyoruz, kirlilik olmasın.
    // Sadece tam eşleşme arıyoruz.
    if (mapUrlNorm === currentNorm) {
      myPage = siteMap[i];
      console.log("BAŞARILI: Sayfa Eşleşti! -> ID:", myPage.id);
      break;
    }
  }

  // Eğer beni bulduysa, kardeşimi ara
  if (myPage) {
    var partnerPage = null;
    for (var j = 0; j < siteMap.length; j++) {
      if (siteMap[j].id === myPage.id && siteMap[j].lang !== myPage.lang) {
        partnerPage = siteMap[j];
        break;
      }
    }

    // Kardeş bulunduysa butonu güncelle
    if (partnerPage) {
      var targetUrl = partnerPage.url;
      console.log("HEDEF BULUNDU: Yönlendirilecek Link ->", targetUrl);

      // TR Sayfasındaysak -> İngilizce Butonunu Bul
      if (myPage.lang === 'tr') {
        // Seçicileri çeşitlendirelim ki kaçırmasın
        var enBtn = document.querySelector('a[href="/en/"]') || 
                    document.querySelector('a[href="en/"]') ||
                    document.querySelector('a[href="/en"]'); // Slashsız ihtimal
        
        if (enBtn) {
          enBtn.setAttribute('href', targetUrl);
          enBtn.style.fontWeight = "bold"; // Çalıştığını belli etmek için kalın yapalım (Test)
        }
      } 
      
      // EN Sayfasındaysak -> Türkçe Butonunu Bul
      else if (myPage.lang === 'en') {
        var trBtn = document.querySelector('a[href="/tr/"]') || 
                    document.querySelector('a[href="tr/"]') ||
                    document.querySelector('a[href="/tr"]');

        if (trBtn) {
          trBtn.setAttribute('href', targetUrl);
          trBtn.style.fontWeight = "bold"; // Çalıştığını belli etmek için kalın yapalım
        }
      }
    } else {
      console.warn("UYARI: Bu sayfanın 'lang_ref' eşi (kardeşi) bulunamadı.");
    }
  } else {
    console.warn("HATA: Şu anki sayfa siteMap içinde bulunamadı. URL veya Normalize sorunu var.");
    console.log("SiteMap Listesi (Kontrol İçin):", siteMap);
  }

  // --- Dış Linkler (Standart) ---
  var links = document.links;
  for (var k = 0; k < links.length; k++) {
    if (links[k].hostname != window.location.hostname) {
      links[k].target = '_blank';
      links[k].rel = 'noopener noreferrer';
    } else if (links[k].href.endsWith(".pdf")) {
      links[k].target = '_blank';
    }
  }

});
</script>