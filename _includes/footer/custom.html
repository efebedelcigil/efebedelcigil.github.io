<script id="sitemap-data" type="application/json">
[
  {%- for p in site.pages -%}
    {%- if p.lang_ref -%}
      {
        "url": "{{ p.url | relative_url }}",
        "id": "{{ p.lang_ref }}",
        "lang": "{{ p.lang }}"
      }{%- unless forloop.last -%},{%- endunless -%}
    {%- endif -%}
  {%- endfor -%}
]
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {

  // --- Veriyi Kutudan Oku ve Çöz ---
  var rawData = document.getElementById('sitemap-data').textContent;
  var siteMap = [];
  try {
    siteMap = JSON.parse(rawData);
  } catch (e) {
    console.error("JSON Hatası:", e);
  }

  // --- Yardımcı: URL Normalizasyon (Tıraşlama) ---
  // Amacımız: "/tr/projeler/" ile "/tr/projeler" farkını yok etmek.
  function normalize(path) {
    if (!path) return "";
    
    // 1. Tam adres (http...) gelirse sadece yolu al
    try {
      if (path.startsWith("http")) {
        path = new URL(path).pathname;
      }
    } catch(e) {}

    // 2. BaseURL veya Domain kalıntılarını temizle (Basit string temizliği)
    // window.location.origin (örn: https://efebedelcigil.github.io) kısmını at
    path = path.replace(window.location.origin, "");
    
    // 3. "index.html" varsa at
    path = path.replace("/index.html", "");
    path = path.replace("index.html", "");

    // 4. Sondaki slash'ı at (En kritik nokta)
    if (path.endsWith("/") && path.length > 1) {
      path = path.slice(0, -1);
    }
    
    // 5. Başta slash yoksa ekle
    if (!path.startsWith("/")) {
      path = "/" + path;
    }

    return path;
  }

  // --- EŞLEŞTİRME BAŞLIYOR ---
  
  var currentPath = normalize(window.location.pathname);
  console.log("DEBUG: Şu anki Sayfa (Normalize):", currentPath);

  // 1. Ben Kimim? (Listeden kendini bul)
  var myPage = null;
  for (var i = 0; i < siteMap.length; i++) {
    // Listede gelen URL'i de normalize et ki şartlar eşit olsun
    if (normalize(siteMap[i].url) === currentPath) {
      myPage = siteMap[i];
      console.log("DEBUG: Kendimi Buldum -> ID:", myPage.id);
      break;
    }
  }

  // 2. Kardeşim Nerede?
  if (myPage) {
    var partnerPage = null;
    for (var j = 0; j < siteMap.length; j++) {
      if (siteMap[j].id === myPage.id && siteMap[j].lang !== myPage.lang) {
        partnerPage = siteMap[j];
        break;
      }
    }

    // 3. Butonu Güncelle
    if (partnerPage) {
      console.log("DEBUG: Hedef Bulundu ->", partnerPage.url);
      
      var targetUrl = partnerPage.url;
      var btn = null;

      if (myPage.lang === 'tr') {
        // İngilizce butonunu bul (Seçici çeşitliliği)
        btn = document.querySelector('a[href="/en/"]') || 
              document.querySelector('a[href="en/"]') || 
              document.querySelector('a[href="/en"]');
      } else if (myPage.lang === 'en') {
        // Türkçe butonunu bul
        btn = document.querySelector('a[href="/tr/"]') || 
              document.querySelector('a[href="tr/"]') || 
              document.querySelector('a[href="/tr"]');
      }

      if (btn) {
        btn.setAttribute('href', targetUrl);
        // İstersen test için rengini değiştirebilirsin (sonra silersin):
        // btn.style.color = "red"; 
      } else {
        console.warn("DEBUG: Hedef bulundu ama menüdeki buton bulunamadı!");
      }
    } else {
      console.warn("DEBUG: Bu sayfanın diğer dilde karşılığı yok.");
    }
  } else {
    console.warn("DEBUG: Şu anki sayfa SiteMap listesinde eşleşmedi.");
    console.log("DEBUG: SiteMap Listesi:", siteMap); // Listeyi konsola dök
  }

  // --- Dış Linkler (Standart) ---
  var links = document.links;
  for (var k = 0; k < links.length; k++) {
    if (links[k].hostname != window.location.hostname) {
      links[k].target = '_blank';
      links[k].rel = 'noopener noreferrer';
    } else if (links[k].href.endsWith(".pdf")) {
      links[k].target = '_blank';
    }
  }

});
</script>