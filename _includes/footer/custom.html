<script id="sitemap-data" type="application/json">
[
  {%- assign valid_pages = "" | split: "" -%}
  {%- for p in site.pages -%}
    {%- if p.lang_ref -%}
      {%- capture json_item -%}{ "url": "{{ p.url | relative_url }}", "id": "{{ p.lang_ref }}", "lang": "{{ p.lang }}" }{%- endcapture -%}
      {%- assign valid_pages = valid_pages | push: json_item -%}
    {%- endif -%}
  {%- endfor -%}
  {{ valid_pages | join: "," }}
]
</script>

<script src="https://unpkg.com/simple-jekyll-search@latest/dest/simple-jekyll-search.min.js"></script>

<script>
(function() {
  "use strict";

  const init = () => {
    console.log("%câš¡ Efe Master Script: BaÅŸlatÄ±lÄ±yor...", "color: #007acc; font-weight: bold;");
    
    const html = document.documentElement;
    const body = document.body;
    const isEn = window.location.pathname.includes('/en/');

    /* --- A. ELEMENT ENJEKSÄ°YONU (Progress, Scroll, Lightbox) --- */
    if (!document.getElementById('reading-progress-bar')) {
      const pb = document.createElement('div'); pb.id = 'reading-progress-bar';
      const sb = document.createElement('button'); sb.id = 'scroll-to-top'; sb.innerHTML = 'â¬†'; sb.title = isEn ? "Scroll to Top" : "YukarÄ± Ã‡Ä±k";
      const lb = document.createElement('div'); lb.className = 'lightbox-overlay'; lb.innerHTML = '<img src="" alt="Zoom">';
      [pb, sb, lb].forEach(el => body.appendChild(el));
    }

    const scrollBtn = document.getElementById('scroll-to-top');
    const progressBar = document.getElementById('reading-progress-bar');
    const lightbox = document.querySelector('.lightbox-overlay');

    /* --- B. DARK MODE --- */
    if (html.classList.contains('dark-mode')) body.classList.add('dark-mode');
    const toggleBtn = document.getElementById('theme-toggle');
    if (toggleBtn) {
      toggleBtn.onclick = () => {
        requestAnimationFrame(() => {
          html.classList.toggle('dark-mode');
          body.classList.toggle('dark-mode');
          localStorage.setItem('theme', html.classList.contains('dark-mode') ? 'dark' : 'light');
        });
      };
    }
    // Preload temizliÄŸi
    setTimeout(() => { html.classList.remove('preload'); body.classList.remove('preload'); }, 200);

    /* --- C. SCROLL MANTIÄžI --- */
    let ticking = false;
    window.onscroll = () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          const winScroll = window.scrollY || html.scrollTop;
          const height = html.scrollHeight - html.clientHeight;
          const scrolled = (winScroll / height) * 100;
          if (progressBar) progressBar.style.width = Math.max(0, Math.min(100, scrolled)) + "%";
          if (scrollBtn) winScroll > 100 ? scrollBtn.classList.add('show') : scrollBtn.classList.remove('show');
          ticking = false;
        });
        ticking = true;
      }
    };
    if (scrollBtn) scrollBtn.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });

    /* --- D. LIGHTBOX & CODE COPY --- */
    document.querySelectorAll('.page__content img:not(.emoji)').forEach(img => {
      img.style.cursor = 'zoom-in';
      img.onclick = () => { lightbox.querySelector('img').src = img.src; lightbox.classList.add('active'); body.style.overflow = 'hidden'; };
    });
    lightbox.onclick = () => { lightbox.classList.remove('active'); body.style.overflow = 'auto'; };

    document.querySelectorAll('div.highlighter-rouge').forEach(block => {
      if (!block.querySelector('.code-header')) {
        const header = document.createElement('div'); header.className = 'code-header';
        header.innerHTML = `<div class="code-controls"><div class="code-dot dot-red"></div><div class="code-dot dot-yellow"></div><div class="code-dot dot-green"></div></div><button class="copy-btn">Copy</button>`;
        block.insertBefore(header, block.firstChild);
        header.querySelector('.copy-btn').onclick = function() {
          navigator.clipboard.writeText(block.querySelector('pre').innerText).then(() => {
            this.innerText = 'Copied!'; setTimeout(() => this.innerText = 'Copy', 2000);
          });
        };
      }
    });

    /* --- E. ARAMA MOTORU AYARLARI (Simple-Jekyll-Search) --- */
    const searchInput = document.querySelector('.search-input');
    if (searchInput) {
      searchInput.setAttribute('placeholder', isEn ? 'Search... (Open: / | Close: ESC)' : 'Ara... (AÃ§: / | Kapat: ESC)');
      
      SimpleJekyllSearch({
        searchInput: searchInput,
        resultsContainer: document.querySelector('.search-results__items'),
        json: '/search.json',
        searchResultTemplate: `
          <li class="search-result-item" style="list-style:none; padding:10px; border-bottom:1px solid rgba(128,128,128,0.1);">
            <a href="{url}" class="result-link" style="text-decoration:none; display:block;">
              <strong style="font-size:16px; color:#007acc; display:block; margin-bottom:4px;">{title}</strong>
              <span style="font-size:13px; color:#666; line-height:1.4;">{content}</span>
            </a>
          </li>`,
        noResultsText: '<li style="padding:15px; color:#666;">SonuÃ§ yok / No results found</li>',
        limit: 10,
        fuzzy: false
      });

      // Manuel Dil Filtresi (CSS ile gizleme)
      const resultsContainer = document.querySelector('.search-results__items');
      searchInput.addEventListener('keyup', () => {
        setTimeout(() => {
          resultsContainer.querySelectorAll('li a').forEach(link => {
            const url = link.getAttribute('href');
            const parent = link.closest('li');
            if ((isEn && !url.includes('/en/')) || (!isEn && url.includes('/en/'))) {
              parent.style.display = 'none';
            }
            // TÄ±klayÄ±nca HafÄ±zaya Yaz (Highlight iÃ§in)
            link.addEventListener('click', () => {
              sessionStorage.setItem('search_keyword', searchInput.value.trim());
            });
          });
        }, 100);
      });
    }

    /* --- F. DÄ°L DEÄžÄ°ÅžTÄ°RME & HARÄ°CÄ° LÄ°NKLER --- */
    const rawData = document.getElementById('sitemap-data');
    if (rawData) {
      const siteMap = JSON.parse(rawData.textContent);
      const normalize = p => p ? p.replace(window.location.origin, "").replace(/(\/index\.html|index\.html|\/)$/, "") || "/" : "";
      const currentNorm = normalize(window.location.pathname);
      const myPage = siteMap.find(p => normalize(p.url) === currentNorm);
      if (myPage) {
        const partner = siteMap.find(p => p.id === myPage.id && p.lang !== myPage.lang);
        const langBtn = document.querySelector(isEn ? 'a[href*="/tr/"]' : 'a[href*="/en/"]');
        if (partner && langBtn) langBtn.setAttribute('href', partner.url);
      }
    }

    document.querySelectorAll('a').forEach(link => {
      if (link.hostname !== window.location.hostname || link.href.endsWith('.pdf')) {
        link.target = '_blank'; link.rel = 'noopener noreferrer';
      }
    });

    /* --- G. HIGHLIGHTER (Hem URL Hem Session Storage Destekli) --- */
    const urlParams = new URLSearchParams(window.location.search);
    const qUrl = urlParams.get('q');
    const qSession = sessionStorage.getItem('search_keyword');
    const query = qUrl || qSession; // Ä°kisine de bak

    if (query && query.length > 1) {
      const cleanQuery = decodeURIComponent(query).replace(/[^\w\sÄŸÃ¼ÅŸÄ±Ã¶Ã§ÄžÃœÅžÄ°Ã–Ã‡]/gi, '').trim();
      console.log("ðŸŽ¯ Highlighter Tetiklendi:", cleanQuery);

      const context = document.querySelector('.page__content') || body;
      const walker = document.createTreeWalker(context, NodeFilter.SHOW_TEXT, null, false);
      const nodeList = [];
      let node;

      while (node = walker.nextNode()) {
        if (node.nodeValue.toLowerCase().includes(cleanQuery.toLowerCase()) && 
            !['SCRIPT', 'STYLE', 'NOSCRIPT', 'MARK'].includes(node.parentNode.nodeName)) {
          nodeList.push(node);
        }
      }

      nodeList.forEach(textNode => {
        const regex = new RegExp(`(${cleanQuery})`, "gi");
        const fragment = document.createDocumentFragment();
        textNode.nodeValue.split(regex).forEach(part => {
          if (part.toLowerCase() === cleanQuery.toLowerCase()) {
            const mark = document.createElement("mark");
            mark.className = "highlighted-term";
            mark.textContent = part;
            fragment.appendChild(mark);
          } else if (part.length > 0) fragment.appendChild(document.createTextNode(part));
        });
        if (textNode.parentNode) textNode.parentNode.replaceChild(fragment, textNode);
      });

      setTimeout(() => {
        const firstMark = document.querySelector('mark.highlighted-term');
        if (firstMark) {
          firstMark.scrollIntoView({ behavior: "smooth", block: "center" });
          sessionStorage.removeItem('search_keyword'); // Temizlik
        }
      }, 600);
    }
  };

  /* --- BAÅžLATMA --- */
  if (document.readyState === 'complete') init();
  else window.addEventListener('load', init);

  /* --- KLAVYE KISAYOLLARI --- */
  document.onkeydown = e => {
    if (e.key === '/' && !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
      e.preventDefault();
      document.querySelector('.search__toggle')?.click();
      setTimeout(() => document.querySelector('.search-input')?.focus(), 150);
    }
    if (e.key === 'Escape') {
      document.querySelector('.lightbox-overlay')?.classList.remove('active');
      document.querySelector('.search-content__close')?.click();
      body.style.overflow = 'auto';
    }
  };

})();
</script>